<?php
/**
 * @file
 * Provides the Provision_Config_Drushrc_Alias class.
 */

/**
 * Class to write an alias records.
 */
class Provision_Config_Drushrc_Alias extends Provision_Config_Drushrc {
  public $template = 'provision_drushrc_alias.tpl.php';

  /**
   * @param $name
   *   String '\@name' for named context.
   * @param $options
   *   Array of string option names to save.
   */
  function __construct($context, $data = array()) {
    parent::__construct($context, $data);

    if (isset($data['aliases']) && is_array($data['aliases'])) {
      $data['aliases'] = array_unique($data['aliases']);
    }
    if (isset($data['drush_aliases']) && is_array($data['drush_aliases'])) {
      $data['drush_aliases'] = array_unique($data['drush_aliases']);
    }

    $name = ltrim($context, '@');
    $environment = isset($data['environment'])? $data['environment'] : $name;
    $project = isset($data['project'])? $data['project'] : $name;

    $alias = "{$project}.{$environment}";

    $this->data = array(
      'aliasname' => $alias,
      'options' => $data,
      'name' => $name,
      'environment' => $environment,
    );
  }

  function filename() {
    return drush_server_home() . '/.drush/' . $this->data['aliasname'] . '.alias.drushrc.php';
  }

  function filenameYaml() {
    return drush_server_home() . '/.drush/sites/' . $this->data['name'] . '.site.yml';
  }

  function write()
  {
    $this->writeSiteAlias();
    return parent::write(); // TODO: Change the autogenerated stub
  }

  /**
   * Write a Drush 9+ YML drush alias.
   * @return void
   */
  function writeSiteAlias() {
    if ($this->context->type == 'site') {
      $alias = [
        $this->data['environment'] => [
          'root' => isset($this->data['options']['root'])? $this->data['options']['root']: d('hostmaster')->root,
          'uri' => isset($this->data['options']['uri']) ? $this->data['options']['uri'] : NULL,
          'options' => $this->data['options'],
        ],
      ];

      // @TODO: If yml file already exists, load it and append.
      $yaml = \Symfony\Component\Yaml\Yaml::dump($alias, 10, 2);
      $filename = $this->filenameYaml();

      provision_file()->file_put_contents($filename, $yaml)
        ->succeed('Wrote Yaml Drush Site Alias file: ' . $filename, 'success')
        ->fail('Could not write Yaml Drush Site Alias file: ' . $filename)
        ->status();
    }
  }

  function delete() {
    unlink($this->filenameYaml());
    unlink($this->filename());
  }
}
